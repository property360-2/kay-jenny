{% extends 'base.html' %}

{% block title %}{{ action }} Ingredient - Cafe Kantina{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-3xl font-bold text-gray-900">{{ action }} Ingredient</h1>
        <p class="mt-1 text-sm text-gray-500">
            {% if ingredient %}Update ingredient details and stock information{% else %}Add a new raw material to your inventory{% endif %}
        </p>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
        <form method="POST" class="space-y-6">
            {% csrf_token %}

            <!-- Basic Information -->
            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-gray-900">Basic Information</h2>

                <!-- Name -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                        Ingredient Name <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        value="{{ ingredient.name|default:'' }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                        placeholder="e.g., Tomato Sauce, Mozzarella Cheese"
                    />
                    <div id="name-validation-message" class="mt-1 text-sm text-red-600"></div>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    <textarea
                        id="description"
                        name="description"
                        rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                        placeholder="Optional description..."
                    >{{ ingredient.description|default:'' }}</textarea>
                </div>

                <!-- Unit -->
                <div>
                    <label for="unit" class="block text-sm font-medium text-gray-700 mb-1">
                        Unit of Measurement <span class="text-red-500">*</span>
                    </label>
                    <select id="unit" name="unit" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500">
                        {% for u in units %}
                        <option value="{{ u }}" {% if ingredient.unit == u %}selected{% endif %}>{{ u }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Stock Information -->
            <div class="space-y-4 pt-4 border-t border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Stock Information</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Current Stock -->
                    <div>
                        <label for="current_stock" class="block text-sm font-medium text-gray-700 mb-1">
                            Current Stock <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="number"
                            id="current_stock"
                            name="current_stock"
                            value="{{ ingredient.current_stock|default:'0' }}"
                            step="0.001"
                            min="0"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                            placeholder="0"
                        />
                        <p class="text-xs text-gray-500 mt-1">Current stock quantity</p>
                    </div>

                    <!-- Minimum Stock -->
                    <div>
                        <label for="min_stock" class="block text-sm font-medium text-gray-700 mb-1">
                            Minimum Stock Level <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="number"
                            id="min_stock"
                            name="min_stock"
                            value="{{ ingredient.min_stock|default:'10' }}"
                            step="0.001"
                            min="0"
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                            placeholder="10"
                        />
                        <p class="text-xs text-gray-500 mt-1">Alert when stock falls below this</p>
                    </div>
                </div>
            </div>

            <!-- Status -->
            {% if ingredient %}
            <div class="space-y-4 pt-4 border-t border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Status</h2>
                <div class="flex items-center">
                    <input
                        type="checkbox"
                        id="is_active"
                        name="is_active"
                        {% if ingredient.is_active %}checked{% endif %}
                        class="w-4 h-4 rounded border-gray-300 text-fjc-blue-600 shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500"
                    />
                    <label for="is_active" class="ml-3 text-sm font-medium text-gray-700">
                        Active - This ingredient is available for recipes
                    </label>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="flex space-x-3 pt-4 border-t border-gray-200">
                <button
                    type="submit"
                    id="ingredientSubmitBtn"
                    class="flex-1 bg-fjc-blue-600 text-white px-6 py-3 rounded-lg hover:bg-fjc-blue-700 font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fjc-blue-500 flex items-center justify-center gap-2"
                >
                    <span id="ingredientSubmitBtnText">{{ action }} Ingredient</span>
                </button>
                <a
                    href="{% url 'products:ingredient_list' %}"
                    class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-300 font-medium text-center shadow-sm"
                >
                    Cancel
                </a>
            </div>
        </form>
    </div>

<!-- Include Toast Component for feedback -->
{% include 'components/toast.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const nameInput = document.getElementById('name');
    const validationMessage = document.getElementById('name-validation-message');
    const submitBtn = document.getElementById('ingredientSubmitBtn');
    const ingredientId = '{{ ingredient.id|default_if_none:"" }}';
    let debounceTimer;

    // Function to check ingredient name via API
    const checkName = () => {
        const name = nameInput.value.trim();
        if (name === '') {
            validationMessage.textContent = '';
            submitBtn.disabled = false;
            return;
        }

        // Construct the API URL
        let url = `{% url 'products:api_check_ingredient_name' %}?name=${encodeURIComponent(name)}`;
        if (ingredientId) {
            url += `&ingredient_id=${ingredientId}`;
        }

        // Fetch API to check for duplicates
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    validationMessage.innerHTML = `
                        <span class="font-semibold">Ingredient already exists.</span>
                        <a href="/products/ingredients/${data.duplicate_id}/edit/" target="_blank" class="ml-2 text-fjc-blue-600 hover:underline">
                            View Existing
                        </a>`;
                    submitBtn.disabled = true;
                    submitBtn.classList.add('cursor-not-allowed', 'opacity-50');
                } else {
                    validationMessage.textContent = '';
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('cursor-not-allowed', 'opacity-50');
                }
            })
            .catch(error => {
                console.error('Error checking ingredient name:', error);
                validationMessage.textContent = 'Could not validate name.';
                submitBtn.disabled = false; // Allow submission on API error
                submitBtn.classList.remove('cursor-not-allowed', 'opacity-50');
            });
    };

    // Add event listener with debounce
    nameInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(checkName, 300); // 300ms delay
    });

    if (form) {
        form.addEventListener('submit', function(e) {
            if (submitBtn) {
                const submitBtnText = document.getElementById('ingredientSubmitBtnText');
                const originalText = submitBtnText.textContent;

                submitBtn.disabled = true;
                submitBtnText.innerHTML = '<div class="flex items-center gap-2"><svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Saving...</div>';
                submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

                // Auto-restore button after 30 seconds (fallback)
                setTimeout(() => {
                    if (submitBtn.disabled) {
                        submitBtn.disabled = false;
                        submitBtnText.textContent = originalText;
                        submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                    }
                }, 30000);
            }
        });
    }
});
</script>
{% endblock %}

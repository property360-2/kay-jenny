{% extends 'base.html' %}

{% block title %}Checkout - Cafe Kantina POS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Checkout</h1>
            <p class="mt-1 text-sm text-gray-500">Complete your order details and payment</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Checkout Form -->
        <form method="post" class="lg:col-span-2 space-y-6">
            {% csrf_token %}

            <!-- Order Details -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 space-y-4">
                <h2 class="text-lg font-semibold text-gray-900 border-b pb-3">Order Details</h2>

                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Special Notes/Instructions</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="e.g., No onions, extra cheese"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 resize-none"></textarea>
                </div>
            </div>

            <!-- Payment Information -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 space-y-4">
                <h2 class="text-lg font-semibold text-gray-900 border-b pb-3">Payment Method</h2>

                <div class="space-y-2">
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50" for="payment_cash">
                        <input type="radio" id="payment_cash" name="payment_method" value="CASH" checked
                               class="w-4 h-4 text-fjc-blue-600 cursor-pointer">
                        <span class="ml-3 font-medium text-gray-900">üíµ Cash Payment</span>
                    </label>

                    <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50" for="payment_gcash">
                        <input type="radio" id="payment_gcash" name="payment_method" value="GCASH"
                               class="w-4 h-4 text-fjc-blue-600 cursor-pointer">
                        <span class="ml-3 font-medium text-gray-900">üì± GCash Payment</span>
                    </label>
                </div>

                <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
                    Payment will be collected when the order is ready.
                </p>
            </div>

            <!-- Submit Buttons -->
            <div class="flex gap-3">
                <a href="{% url 'orders:pos_cart' %}" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-center transition">
                    ‚Üê Back to Cart
                </a>
                <button type="submit" class="flex-1 px-6 py-3 bg-fjc-blue-600 text-white rounded-lg hover:bg-fjc-blue-700 font-medium text-center transition">
                    Complete Order ‚Üí
                </button>
            </div>
        </form>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 sticky top-24 space-y-6">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Order Summary</h2>
                </div>

                {% if cart %}
                <div class="space-y-3 max-h-96 overflow-y-auto border-b pb-4">
                    {% for product_id, item in cart.items %}
                    <div class="flex justify-between text-sm">
                        <div>
                            <p class="font-medium text-gray-900">{{ item.name }}</p>
                            <p class="text-gray-600">{{ item.quantity }} √ó ‚Ç±{{ item.price|floatformat:2 }}</p>
                        </div>
                        <p class="font-semibold text-fjc-blue-600">‚Ç±{{ item.subtotal|floatformat:2 }}</p>
                    </div>
                    {% endfor %}
                </div>

                <div class="space-y-3 py-4 border-y border-gray-200">
                    <div class="flex justify-between text-gray-700">
                        <span>Items:</span>
                        <span class="font-medium">{{ cart|length }}</span>
                    </div>
                    <div class="flex justify-between text-gray-700">
                        <span>Subtotal:</span>
                        <span class="font-medium">‚Ç±{{ total|floatformat:2 }}</span>
                    </div>
                </div>

                <!-- Order Total Card -->
                <div class="bg-gradient-to-r from-fjc-blue-50 to-fjc-blue-100 p-5 rounded-xl border border-fjc-blue-200">
                    <p class="text-sm text-gray-600 mb-1">Order Total</p>
                    <p id="checkout-total-amount" class="text-4xl font-bold text-fjc-blue-600">‚Ç±{{ total|floatformat:2 }}</p>
                </div>

                <!-- Customer Payment Section -->
                <div class="border-t border-gray-200 pt-4 space-y-3">
                    <label for="customer_paid_amount" class="block text-sm font-semibold text-gray-800">Amount Paid by Customer</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-2xl text-gray-400">‚Ç±</span>
                        <input type="number" id="customer_paid_amount" placeholder="Enter amount" step="0.01" min="0"
                               class="w-full pl-8 pr-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500 transition font-semibold">
                    </div>
                </div>

                <!-- Change Display Card -->
                <div id="change-display-card" class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-xl border-2 border-green-200 hidden">
                    <p class="text-xs text-gray-600 mb-1">Change</p>
                    <p id="change-amount-display" class="text-3xl font-bold text-green-600">‚Ç±0.00</p>
                </div>

                <!-- Insufficient Warning -->
                <div id="insufficient-warning" class="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-xl border-2 border-red-200 hidden">
                    <p id="insufficient-message" class="text-lg font-bold text-red-600">Insufficient: ‚Ç±0.00 short</p>
                </div>

                <div id="payment-method-display" class="bg-green-50 border border-green-300 p-3 rounded-lg text-sm text-green-800">
                    <span class="material-icons">check_circle</span> Payment method: <span id="selected-payment-method">Cash</span>
                </div>
                {% else %}
                <div class="text-center text-gray-500">
                    <p>No items in cart</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // ===== Change Calculator =====
    const customerPaidInput = document.getElementById('customer_paid_amount');
    const changeDisplayCard = document.getElementById('change-display-card');
    const insufficientWarning = document.getElementById('insufficient-warning');
    const changeAmountDisplay = document.getElementById('change-amount-display');
    const insufficientMessage = document.getElementById('insufficient-message');
    const totalAmount = parseFloat(document.getElementById('checkout-total-amount').textContent.replace('‚Ç±', ''));
    const submitBtn = document.querySelector('button[type="submit"]');

    function updateChangeCalculation() {
        const paidAmount = parseFloat(customerPaidInput.value) || 0;
        const change = paidAmount - totalAmount;

        if (paidAmount === 0) {
            // No amount entered yet
            changeDisplayCard.classList.add('hidden');
            insufficientWarning.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else if (change >= 0) {
            // Sufficient payment
            changeDisplayCard.classList.remove('hidden');
            insufficientWarning.classList.add('hidden');
            changeAmountDisplay.textContent = `‚Ç±${change.toFixed(2)}`;
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            // Insufficient payment
            changeDisplayCard.classList.add('hidden');
            insufficientWarning.classList.remove('hidden');
            insufficientMessage.textContent = `Insufficient: ‚Ç±${Math.abs(change).toFixed(2)} short`;
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    // ===== Payment Method Display Update =====
    function updatePaymentMethodDisplay() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
        const displayText = document.getElementById('selected-payment-method');
        displayText.textContent = selectedMethod === 'CASH' ? 'Cash' : selectedMethod === 'GCASH' ? 'GCash' : selectedMethod;
    }

    // Add event listeners for change calculation
    customerPaidInput.addEventListener('input', updateChangeCalculation);

    // Add event listeners for payment method radio buttons
    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', updatePaymentMethodDisplay);
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateChangeCalculation();
        updatePaymentMethodDisplay();
    });
</script>
{% endblock %}

{% extends 'base.html' %}

{% block title %}Checkout - Cafe Cantina POS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Checkout</h1>
            <p class="mt-1 text-sm text-gray-500">Complete your order details and payment</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Checkout Form -->
        <form method="post" class="lg:col-span-2 space-y-6">
            {% csrf_token %}

            <!-- Customer Details -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 space-y-4">
                <h2 class="text-lg font-semibold text-gray-900 border-b pb-3">Customer Information</h2>

                <div>
                    <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-2">Customer Name</label>
                    <input type="text" id="customer_name" name="customer_name" placeholder="Walk-in Customer"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fjc-blue-500"
                           required>
                </div>

                <!-- Takeout Checkbox -->
                <div class="flex items-center gap-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <input type="checkbox" id="is_takeout" name="is_takeout"
                           class="w-4 h-4 text-fjc-blue-600 cursor-pointer">
                    <label for="is_takeout" class="text-sm font-medium text-gray-900 cursor-pointer">
                        üì¶ Takeout Order (No table number needed)
                    </label>
                </div>

                <!-- Table Number Field (hidden when takeout is checked) -->
                <div id="table_number_container">
                    <label for="table_number" class="block text-sm font-medium text-gray-700 mb-2">Table Number (Optional)</label>
                    <input type="text" id="table_number" name="table_number" placeholder="e.g., Table 5"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fjc-blue-500">
                </div>

                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Special Notes/Instructions</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="e.g., No onions, extra cheese"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 resize-none"></textarea>
                </div>
            </div>

            <!-- Payment Information -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 space-y-4">
                <h2 class="text-lg font-semibold text-gray-900 border-b pb-3">Payment Method</h2>

                <div class="space-y-2">
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50" for="payment_cash">
                        <input type="radio" id="payment_cash" name="payment_method" value="CASH" checked
                               class="w-4 h-4 text-fjc-blue-600 cursor-pointer">
                        <span class="ml-3 font-medium text-gray-900">üíµ Cash Payment</span>
                    </label>
                </div>

                <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
                    Payment will be collected when the order is ready.
                </p>
            </div>

            <!-- Submit Buttons -->
            <div class="flex gap-3">
                <a href="{% url 'orders:pos_cart' %}" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-center transition">
                    ‚Üê Back to Cart
                </a>
                <button type="submit" class="flex-1 px-6 py-3 bg-fjc-blue-600 text-white rounded-lg hover:bg-fjc-blue-700 font-medium text-center transition">
                    Complete Order ‚Üí
                </button>
            </div>
        </form>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 sticky top-24 space-y-6">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Order Summary</h2>
                </div>

                {% if cart %}
                <div class="space-y-3 max-h-96 overflow-y-auto border-b pb-4">
                    {% for product_id, item in cart.items %}
                    <div class="flex justify-between text-sm">
                        <div>
                            <p class="font-medium text-gray-900">{{ item.name }}</p>
                            <p class="text-gray-600">{{ item.quantity }} √ó ‚Ç±{{ item.price|floatformat:2 }}</p>
                        </div>
                        <p class="font-semibold text-fjc-blue-600">‚Ç±{{ item.subtotal|floatformat:2 }}</p>
                    </div>
                    {% endfor %}
                </div>

                <div class="space-y-3 py-4 border-y border-gray-200">
                    <div class="flex justify-between text-gray-700">
                        <span>Items:</span>
                        <span class="font-medium">{{ cart|length }}</span>
                    </div>
                    <div class="flex justify-between text-gray-700">
                        <span>Subtotal:</span>
                        <span class="font-medium">‚Ç±{{ total|floatformat:2 }}</span>
                    </div>
                </div>

                <!-- Order Total Card -->
                <div class="bg-gradient-to-r from-fjc-blue-50 to-fjc-blue-100 p-5 rounded-xl border border-fjc-blue-200">
                    <p class="text-sm text-gray-600 mb-1">Order Total</p>
                    <p id="checkout-total-amount" class="text-4xl font-bold text-fjc-blue-600">‚Ç±{{ total|floatformat:2 }}</p>
                </div>

                <!-- Customer Payment Section -->
                <div class="border-t border-gray-200 pt-4 space-y-3">
                    <label for="customer_paid_amount" class="block text-sm font-semibold text-gray-800">Amount Paid by Customer</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-2xl text-gray-400">‚Ç±</span>
                        <input type="number" id="customer_paid_amount" placeholder="Enter amount" step="0.01" min="0"
                               class="w-full pl-8 pr-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500 transition font-semibold">
                    </div>
                </div>

                <!-- Change Display Card -->
                <div id="change-display-card" class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-xl border-2 border-green-200 hidden">
                    <p class="text-xs text-gray-600 mb-1">Change</p>
                    <p id="change-amount-display" class="text-3xl font-bold text-green-600">‚Ç±0.00</p>
                </div>

                <!-- Insufficient Warning -->
                <div id="insufficient-warning" class="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-xl border-2 border-red-200 hidden">
                    <p id="insufficient-message" class="text-lg font-bold text-red-600">Insufficient: ‚Ç±0.00 short</p>
                </div>

                <div class="bg-green-50 border border-green-300 p-3 rounded-lg text-sm text-green-800">
                    <span class="material-icons">check_circle</span> Payment method: Cash
                </div>
                {% else %}
                <div class="text-center text-gray-500">
                    <p>No items in cart</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle table number field when takeout checkbox changes
    const takeoutCheckbox = document.getElementById('is_takeout');
    const tableNumberContainer = document.getElementById('table_number_container');
    const tableNumberInput = document.getElementById('table_number');

    function toggleTableNumber() {
        if (takeoutCheckbox.checked) {
            // Hide table number field when takeout is checked
            tableNumberContainer.style.display = 'none';
            tableNumberInput.value = '';  // Clear the field
            tableNumberInput.removeAttribute('required');
        } else {
            // Show table number field when takeout is unchecked
            tableNumberContainer.style.display = 'block';
        }
    }

    // Add event listener to checkbox
    takeoutCheckbox.addEventListener('change', toggleTableNumber);

    // ===== Change Calculator =====
    const customerPaidInput = document.getElementById('customer_paid_amount');
    const changeDisplayCard = document.getElementById('change-display-card');
    const insufficientWarning = document.getElementById('insufficient-warning');
    const changeAmountDisplay = document.getElementById('change-amount-display');
    const insufficientMessage = document.getElementById('insufficient-message');
    const totalAmount = parseFloat(document.getElementById('checkout-total-amount').textContent.replace('‚Ç±', ''));
    const submitBtn = document.querySelector('button[type="submit"]');

    function updateChangeCalculation() {
        const paidAmount = parseFloat(customerPaidInput.value) || 0;
        const change = paidAmount - totalAmount;

        if (paidAmount === 0) {
            // No amount entered yet
            changeDisplayCard.classList.add('hidden');
            insufficientWarning.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else if (change >= 0) {
            // Sufficient payment
            changeDisplayCard.classList.remove('hidden');
            insufficientWarning.classList.add('hidden');
            changeAmountDisplay.textContent = `‚Ç±${change.toFixed(2)}`;
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            // Insufficient payment
            changeDisplayCard.classList.add('hidden');
            insufficientWarning.classList.remove('hidden');
            insufficientMessage.textContent = `Insufficient: ‚Ç±${Math.abs(change).toFixed(2)} short`;
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    // Add event listener for change calculation
    customerPaidInput.addEventListener('input', updateChangeCalculation);

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        toggleTableNumber();
        updateChangeCalculation();
    });
</script>
{% endblock %}

<!-- Toast Notification Component -->
<div id="toast-container" class="fixed top-4 right-4 left-4 sm:left-auto sm:right-4 z-50 space-y-2 max-w-md sm:max-w-none" style="pointer-events: none;" aria-live="polite" aria-atomic="false">
    <!-- Toasts will be dynamically inserted here -->
</div>

<!-- Screen reader announcements for status updates -->
<div id="sr-announcements" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

<style>
    .toast {
        pointer-events: auto;
        width: 100%;
        max-width: 100%;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideIn 0.3s ease-out;
        transition: all 0.3s ease;
    }

    @media (min-width: 640px) {
        .toast {
            min-width: 300px;
            max-width: 500px;
            width: auto;
        }
    }

    .toast.hiding {
        animation: slideOut 0.3s ease-out;
        opacity: 0;
        transform: translateX(100%);
    }

    .toast-success {
        background-color: #10b981;
        color: white;
    }

    .toast-error {
        background-color: #ef4444;
        color: white;
    }

    .toast-warning {
        background-color: #f59e0b;
        color: white;
    }

    .toast-info {
        background-color: #3b82f6;
        color: white;
    }

    .toast-icon {
        flex-shrink: 0;
        width: 1.5rem;
        height: 1.5rem;
    }

    .toast-message {
        flex: 1;
        font-weight: 500;
    }

    .toast-close {
        flex-shrink: 0;
        width: 1.5rem;
        height: 1.5rem;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .toast-close:hover {
        opacity: 1;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* Loading Spinner */
    .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        width: 1.25rem;
        height: 1.25rem;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-overlay .spinner-large {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        width: 3rem;
        height: 3rem;
        animation: spin 0.8s linear infinite;
    }

    /* Pulse Animation */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Modal Animations */
    .modal-backdrop {
        animation: fadeInBackdrop 0.2s ease-out;
    }

    .modal-content {
        animation: slideUpModal 0.3s ease-out;
    }

    .modal-backdrop.fadeOut {
        animation: fadeOutBackdrop 0.2s ease-out;
    }

    @keyframes fadeInBackdrop {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes fadeOutBackdrop {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    @keyframes slideUpModal {
        from {
            transform: translateY(1rem);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Disable/Loading state for buttons */
    button[disabled], .btn-disabled {
        opacity: 0.6;
        cursor: not-allowed !important;
        pointer-events: none !important;
    }

    .btn-loading {
        position: relative;
        color: transparent;
    }

    .btn-loading::after {
        content: '';
        position: absolute;
        width: 1rem;
        height: 1rem;
        top: 50%;
        left: 50%;
        margin-left: -0.5rem;
        margin-top: -0.5rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }
</style>

<script>
// Toast Notification System
if (typeof window.Toast === 'undefined') {
window.Toast = {
    show(message, type = 'info', duration = 4000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'polite');

        const typeLabels = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Information'
        };
        toast.setAttribute('aria-label', `${typeLabels[type]}: ${message}`);

        const icons = {
            success: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
            error: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
            warning: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
            info: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        };

        toast.innerHTML = `
            ${icons[type]}
            <div class="toast-message">${message}</div>
            <button class="toast-close" aria-label="Close notification" onclick="this.parentElement.remove()" type="button">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;

        container.appendChild(toast);

        if (duration > 0) {
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        return toast;
    },

    success(message, duration) {
        return this.show(message, 'success', duration);
    },

    error(message, duration) {
        return this.show(message, 'error', duration);
    },

    warning(message, duration) {
        return this.show(message, 'warning', duration);
    },

    info(message, duration) {
        return this.show(message, 'info', duration);
    }
};
}

// Loading Overlay
if (typeof window.Loading === 'undefined') {
window.Loading = {
    show() {
        if (document.getElementById('loading-overlay')) return;

        const overlay = document.createElement('div');
        overlay.id = 'loading-overlay';
        overlay.className = 'loading-overlay';
        overlay.innerHTML = '<div class="spinner-large"></div>';
        document.body.appendChild(overlay);
    },

    hide() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.remove();
    }
};
}

// Request Deduplication - prevents double submission
if (typeof window.RequestDedup === 'undefined') {
window.RequestDedup = {
    _pending: new Map(),

    async execute(key, fn) {
        if (this._pending.has(key)) {
            return this._pending.get(key);
        }

        try {
            const promise = fn();
            this._pending.set(key, promise);
            const result = await promise;
            return result;
        } finally {
            this._pending.delete(key);
        }
    },

    clear(key) {
        this._pending.delete(key);
    }
};
}

// Form Helper - automatically disables submit button and shows loading
if (typeof window.FormHelper === 'undefined') {
window.FormHelper = {
    setupSubmit(formSelector, options = {}) {
        const form = typeof formSelector === 'string' ? document.querySelector(formSelector) : formSelector;
        if (!form) return;

        const submitBtn = form.querySelector('button[type="submit"]');
        if (!submitBtn) return;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Disable submit button
            submitBtn.disabled = true;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="inline-flex items-center gap-2"><svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" style="opacity:0.25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>' + (options.loadingText || 'Processing...') + '</span>';

            try {
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => data[key] = value);

                const url = form.action || window.location.href;
                const method = form.method.toUpperCase() || 'POST';

                let response;
                if (method === 'POST') {
                    response = await fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                } else {
                    response = await fetch(url, {
                        method: method,
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                }

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();

                if (result.success) {
                    Toast.success(result.message || 'Operation successful');
                    if (options.onSuccess) {
                        options.onSuccess(result);
                    } else if (result.redirect_url) {
                        setTimeout(() => window.location.href = result.redirect_url, 500);
                    }
                } else {
                    Toast.error(result.message || 'Operation failed');
                    if (options.onError) options.onError(result);
                }
            } catch (error) {
                console.error('Form submission error:', error);
                Toast.error('An error occurred. Please try again.');
                if (options.onError) options.onError(error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }
};
}

// AJAX Helper
if (typeof window.Ajax === 'undefined') {
window.Ajax = {
    async post(url, data, options = {}) {
        try {
            if (options.showLoading !== false) Loading.show();

            const formData = new FormData();
            Object.keys(data).forEach(key => {
                formData.append(key, data[key]);
            });

            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken);
            }

            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken || '',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const result = await response.json();

            if (options.showLoading !== false) Loading.hide();

            if (result.success) {
                if (options.successMessage !== false) {
                    Toast.success(result.message || 'Operation successful');
                }
            } else {
                if (options.errorMessage !== false) {
                    Toast.error(result.message || 'Operation failed');
                }
            }

            return result;
        } catch (error) {
            if (options.showLoading !== false) Loading.hide();
            if (options.errorMessage !== false) {
                Toast.error('Network error. Please try again.');
            }
            throw error;
        }
    },

    async get(url, options = {}) {
        try {
            if (options.showLoading !== false) Loading.show();

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const result = await response.json();

            if (options.showLoading !== false) Loading.hide();

            return result;
        } catch (error) {
            if (options.showLoading !== false) Loading.hide();
            if (options.errorMessage !== false) {
                Toast.error('Network error. Please try again.');
            }
            throw error;
        }
    }
};
}

// Form Submission Helper
function submitFormAsync(form, options = {}) {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => data[key] = value);

        const result = await Ajax.post(form.action, data, options);

        if (result.success && options.onSuccess) {
            options.onSuccess(result);
        } else if (!result.success && options.onError) {
            options.onError(result);
        }
    });
}

// Custom Confirmation Modal
if (typeof window.Confirm === 'undefined') {
window.Confirm = {
    show(options = {}) {
        const {
            title = 'Confirm Action',
            message = 'Are you sure?',
            confirmText = 'Confirm',
            cancelText = 'Cancel',
            type = 'warning',
            onConfirm = null,
            onCancel = null
        } = options;

        // Create modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] modal-backdrop';
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-sm mx-4 modal-content" role="dialog" aria-labelledby="confirmTitle" aria-modal="true">
                <div class="p-6">
                    <!-- Icon -->
                    <div class="flex justify-center mb-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${
                            type === 'danger' ? 'bg-red-100' :
                            type === 'warning' ? 'bg-yellow-100' :
                            'bg-blue-100'
                        }">
                            ${
                                type === 'danger'
                                    ? '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'
                                    : type === 'warning'
                                    ? '<svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'
                                    : '<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                            }
                        </div>
                    </div>

                    <!-- Title -->
                    <h3 id="confirmTitle" class="text-lg font-semibold text-gray-900 text-center mb-2">${title}</h3>

                    <!-- Message -->
                    <p class="text-gray-600 text-center text-sm mb-6">${message}</p>

                    <!-- Buttons -->
                    <div class="flex gap-3">
                        <button class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition cancel-btn" autofocus>
                            ${cancelText}
                        </button>
                        <button class="flex-1 px-4 py-2 rounded-lg font-medium text-white transition ${
                            type === 'danger' ? 'bg-red-600 hover:bg-red-700' :
                            type === 'warning' ? 'bg-yellow-600 hover:bg-yellow-700' :
                            'bg-fjc-blue-600 hover:bg-fjc-blue-700'
                        } confirm-btn">
                            ${confirmText}
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Event handlers
        const confirmBtn = modal.querySelector('.confirm-btn');
        const cancelBtn = modal.querySelector('.cancel-btn');

        const cleanup = () => {
            modal.classList.add('fadeOut');
            setTimeout(() => modal.remove(), 200);
        };

        confirmBtn.addEventListener('click', () => {
            cleanup();
            if (onConfirm) onConfirm();
        });

        cancelBtn.addEventListener('click', () => {
            cleanup();
            if (onCancel) onCancel();
        });

        // Keyboard support
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                cleanup();
                if (onCancel) onCancel();
            }
        });

        // Click outside to cancel
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                cleanup();
                if (onCancel) onCancel();
            }
        });

        return modal;
    }
};
}

// Legacy compatibility
function confirmAction(message, onConfirm, onCancel) {
    Confirm.show({
        message: message,
        onConfirm: onConfirm,
        onCancel: onCancel
    });
}

// Auto-refresh helper
function autoRefresh(interval = 30000) {
    setTimeout(() => {
        location.reload();
    }, interval);
}
</script>
